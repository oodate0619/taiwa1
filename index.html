<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¨ªå•ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ï¼ˆå¯¾è©±ãƒ‡ãƒ¢ï¼‰</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --card:#ffffff;
      --muted:#5b6475;
      --text:#111827;
      --accent:#2563eb;
      --accent2:#7c3aed;
      --danger:#dc2626;
      --ok:#16a34a;
      --border:rgba(17,24,39,.10);
      --shadow:0 10px 26px rgba(17,24,39,.10);
      --radius:16px;
      --radius2:18px;
      --chip:#f3f4f6;
      --chipHover:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans";
      background: radial-gradient(1000px 600px at 10% 0%, rgba(37,99,235,.10), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(124,58,237,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(246,247,251,.82);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px 16px;}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center;}
    .logo{
      width:40px; height:40px; border-radius:12px;
      background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(124,58,237,.95));
      box-shadow: var(--shadow);
    }
    .title{line-height:1.25}
    .title h1{font-size:16px; margin:0}
    .title p{margin:2px 0 0; color:var(--muted); font-size:12px}

    button, .pill{
      border:1px solid var(--border);
      background: #fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: .15s ease;
      font-weight:700;
      font-size:13px;
      box-shadow: 0 1px 0 rgba(17,24,39,.04);
    }
    button:hover{transform: translateY(-1px); border-color: rgba(37,99,235,.25)}
    button:active{transform: translateY(0px)}
    button.primary{
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(124,58,237,.10));
      border-color: rgba(37,99,235,.25);
      color: #0b1b4a;
    }
    button.danger{
      background: rgba(220,38,38,.08);
      border-color: rgba(220,38,38,.22);
      color:#7f1d1d;
    }
    button.voice{
      background: rgba(22,163,74,.08);
      border-color: rgba(22,163,74,.22);
      color:#14532d;
      white-space:nowrap;
    }
    button.ghost{
      background: #fff;
    }

    main .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      padding:16px;
      max-width:1100px;
      margin:0 auto;
    }
    @media (max-width: 980px){
      main .grid{grid-template-columns: 1fr; }
      header .title p{display:none;}
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 640px;
      display:flex;
      flex-direction:column;
    }
    .panel .hd{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(17,24,39,.02), transparent);
    }
    .panel .hd .sub{color:var(--muted); font-size:12px}
    .panel .bd{padding:14px; display:flex; flex-direction:column; gap:12px; overflow:auto;}
    .panel .ft{
      padding:12px 14px;
      border-top:1px solid var(--border);
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(17,24,39,.02);
      position: sticky;
      bottom: 0;
    }

    .input{
      flex:1;
      border:1px solid var(--border);
      background: #fff;
      color:var(--text);
      padding:11px 12px;
      border-radius: 14px;
      outline:none;
      font-size:14px;
    }
    .muted{color:var(--muted)}
    .small{font-size:12px; color:var(--muted)}

    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: var(--chip);
      cursor:pointer;
      font-size:13px;
      user-select:none;
      transition: .15s ease;
      font-weight:700;
    }
    .chip:hover{background:var(--chipHover); transform: translateY(-1px)}
    .chip:active{transform: translateY(0px)}
    .chip.selected{
      border-color: rgba(37,99,235,.28);
      background: rgba(37,99,235,.10);
    }

    .msg{display:flex; gap:10px; align-items:flex-start;}
    .avatar{
      width:32px; height:32px; border-radius:12px;
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.18);
      display:flex; align-items:center; justify-content:center;
      font-size:14px;
      flex:0 0 auto;
      color:#1d4ed8;
      font-weight:900;
    }
    .bubble{
      max-width: 86%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: #fff;
      line-height:1.55;
      font-size:14px;
      white-space:pre-wrap;
    }
    .msg.me{justify-content:flex-end}
    .msg.me .bubble{
      background: rgba(37,99,235,.08);
      border-color: rgba(37,99,235,.18);
      max-width: 90%;
    }
    .msg.me .avatar{display:none}

    .card{
      border:1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
    }
    .card h3{margin:0 0 8px; font-size:14px}
    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:8px 10px;
      font-size:13px;
    }
    .kv div:nth-child(odd){color:var(--muted)}
    .hr{height:1px; background: var(--border); margin:12px 0}

    table{
      width:100%;
      border-collapse: collapse;
      font-size:12.5px;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
    }
    th, td{
      border-bottom:1px solid rgba(17,24,39,.06);
      padding:10px 10px;
      text-align:left;
      vertical-align:top;
    }
    th{
      color: var(--muted);
      font-weight:800;
      background: rgba(17,24,39,.03);
    }
    tr:last-child td{border-bottom:none}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 9px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(17,24,39,.03);
      font-size:11.5px;
      font-weight:900;
    }
    .b-matsu{border-color: rgba(37,99,235,.25); background: rgba(37,99,235,.10); color:#1d4ed8}
    .b-take{border-color: rgba(124,58,237,.25); background: rgba(124,58,237,.10); color:#6d28d9}
    .b-ume{border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.10); color:#166534}

    /* Mobile ergonomics */
    @media (max-width: 520px){
      .panel{min-height: 560px;}
      .panel .bd{padding:12px}
      .panel .ft{gap:8px; padding:10px}
      button, .pill{padding:11px 12px}
      .chip{padding:11px 12px}
      .kv{grid-template-columns: 110px 1fr;}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>è¨ªå•ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆå¯¾è©±ãƒ‡ãƒ¢ï¼‰</h1>
          <p>é¸æŠè‚¢ä¸­å¿ƒã§å…¥åŠ› â†’ ãƒ«ãƒ¼ãƒˆæ¡ˆï¼ˆæ¾/ç«¹/æ¢…ï¼‰ã‚’è‡ªå‹•æç¤º</p>
        </div>
      </div>
      <div class="actions" style="display:flex; gap:10px; align-items:center;">
        <button id="btnReset" class="danger">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- Chat -->
    <section class="panel" aria-label="å¯¾è©±ãƒ‘ãƒãƒ«">
      <div class="hd">
        <div>
          <div style="font-weight:900">å¯¾è©±</div>
          <div class="sub">é¸æŠè‚¢ã‚’æŠ¼ã—ã¦é€²ã‚ã‚‹ / è‡ªç”±å…¥åŠ›ãƒ»éŸ³å£°å…¥åŠ›ã‚‚å¯èƒ½</div>
        </div>
        <div class="small muted" id="stepLabel">Step 0/5</div>
      </div>

      <div class="bd" id="chat"></div>

      <div class="ft">
        <!-- ç›®ç«‹ã¤ä½ç½®ã«ç§»å‹•ï¼šã‚¹ãƒãƒ›ã§ã‚‚æŠ¼ã—ã‚„ã™ã„ -->
        <button id="btnSample" class="primary" title="å…¥åŠ›ä¾‹ã§è‡ªå‹•å…¥åŠ›ã—ã¾ã™">å…¥åŠ›ä¾‹ã§ä¸€æ°—ã«é€²ã‚ã‚‹</button>

        <input id="freeInput" class="input" placeholder="è‡ªç”±å…¥åŠ›ï¼ˆä¾‹ï¼šå„ªå…ˆã¯é…åˆ»ã‚¼ãƒ­ã€ä»¶æ•°ã¯æœ€å¤§10ä»¶ï¼‰" />

        <button id="btnVoice" class="voice" title="éŸ³å£°ã§å…¥åŠ›ã—ã¾ã™">ğŸ¤ éŸ³å£°</button>
        <button id="btnSend" class="primary" title="å…¥åŠ›ã‚’é€ä¿¡ã—ã¾ã™">é€ä¿¡</button>
      </div>
    </section>

    <!-- Summary / Output -->
    <aside class="panel" aria-label="çµæœãƒ‘ãƒãƒ«">
      <div class="hd">
        <div>
          <div style="font-weight:900">å…¥åŠ›ã‚µãƒãƒªãƒ¼ & å‡ºåŠ›</div>
          <div class="sub">æ¡ä»¶ãŒæƒã£ãŸã‚‰ã€Œå‡ºåŠ›ã™ã‚‹ã€ã§3æ¡ˆã‚’è¡¨ç¤ºã—ã¾ã™</div>
        </div>
        <div class="small muted" id="statusLabel">å…¥åŠ›ä¸­</div>
      </div>
      <div class="bd">
        <div class="card">
          <h3>ä»Šå›ã®æ¡ä»¶</h3>
          <div class="kv" id="summaryKV">
            <div>æ‹…å½“è€…</div><div class="muted">æœªè¨­å®š</div>
            <div>è¨ªå•ä»¶æ•°</div><div class="muted">æœªè¨­å®š</div>
            <div>å„ªå…ˆ</div><div class="muted">æœªè¨­å®š</div>
            <div>åˆ¶ç´„</div><div class="muted">æœªè¨­å®š</div>
            <div>å‡ºç™ºæ‹ ç‚¹</div><div class="muted">æœªè¨­å®š</div>
          </div>
        </div>

        <div class="card" id="outputCard" style="display:none;">
          <h3>ãƒ«ãƒ¼ãƒˆæ¡ˆï¼ˆæ¾ / ç«¹ / æ¢…ï¼‰</h3>
          <div class="small muted" id="outputNote" style="margin-bottom:10px;"></div>
          <div style="overflow:auto;">
            <table id="planTable"></table>
          </div>
        </div>
      </div>
    </aside>
  </div>
</main>

<script>
  /**
   * Demo1: Chat-like assistant (Static / No API)
   * - Button-first to reduce typing friction
   * - Voice input via Web Speech API (SpeechRecognition)
   */

  const state = {
    step: 0,
    assignee: null,
    base: null,
    visitCount: null,
    priority: null,
    constraints: [],
    freeNotes: [],
  };

  const STEPS_TOTAL = 5;

  const chatEl = document.getElementById('chat');
  const stepLabel = document.getElementById('stepLabel');
  const statusLabel = document.getElementById('statusLabel');

  const summaryKV = document.getElementById('summaryKV');
  const outputCard = document.getElementById('outputCard');
  const planTable = document.getElementById('planTable');
  const outputNote = document.getElementById('outputNote');

  const freeInput = document.getElementById('freeInput');
  const btnSend = document.getElementById('btnSend');
  const btnReset = document.getElementById('btnReset');
  const btnSample = document.getElementById('btnSample');
  const btnVoice = document.getElementById('btnVoice');

  let recognizing = false;
  let recognition = null;

  function setStep(n){
    state.step = n;
    stepLabel.textContent = `Step ${Math.min(state.step, STEPS_TOTAL)}/${STEPS_TOTAL}`;
    statusLabel.textContent = (state.step >= STEPS_TOTAL) ? 'å‡ºåŠ›æ¸ˆã¿' : 'å…¥åŠ›ä¸­';
    renderSummary();
  }

  function addMsg(role, text){
    const row = document.createElement('div');
    row.className = 'msg ' + (role === 'me' ? 'me' : 'bot');

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'me' ? '' : 'AI';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = text;

    if(role !== 'me') row.appendChild(avatar);
    row.appendChild(bubble);

    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addChips(options, onPick, allowMulti=false){
    const wrap = document.createElement('div');
    wrap.className = 'chips';

    options.forEach(opt=>{
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = opt.label ?? opt;
      chip.dataset.value = opt.value ?? opt;

      chip.addEventListener('click', ()=>{
        if(allowMulti){
          chip.classList.toggle('selected');
          onPick(getSelectedValues(wrap));
        }else{
          [...wrap.querySelectorAll('.chip')].forEach(c=>c.classList.remove('selected'));
          chip.classList.add('selected');
          onPick(chip.dataset.value);
          setTimeout(()=>{ proceed(); }, 120);
        }
      });

      wrap.appendChild(chip);
    });

    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
    return wrap;
  }

  function getSelectedValues(container){
    return [...container.querySelectorAll('.chip.selected')].map(c=>c.dataset.value);
  }

  function renderSummary(){
    const kv = [
      ['æ‹…å½“è€…', state.assignee ?? 'æœªè¨­å®š'],
      ['è¨ªå•ä»¶æ•°', state.visitCount ?? 'æœªè¨­å®š'],
      ['å„ªå…ˆ', state.priority ?? 'æœªè¨­å®š'],
      ['åˆ¶ç´„', state.constraints.length ? state.constraints.join(' / ') : 'æœªè¨­å®š'],
      ['å‡ºç™ºæ‹ ç‚¹', state.base ?? 'æœªè¨­å®š'],
    ];
    summaryKV.innerHTML = kv.map(([k,v])=>`<div>${k}</div><div class="${v==='æœªè¨­å®š'?'muted':''}">${escapeHtml(v)}</div>`).join('');
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function resetAll(){
    state.step = 0;
    state.assignee = null;
    state.base = null;
    state.visitCount = null;
    state.priority = null;
    state.constraints = [];
    state.freeNotes = [];

    chatEl.innerHTML = '';
    outputCard.style.display = 'none';
    planTable.innerHTML = '';
    outputNote.textContent = '';
    setStep(0);

    boot();
  }

  function boot(){
    addMsg('bot',
      `ã“ã‚“ã«ã¡ã¯ã€‚ãƒ«ãƒ¼ãƒˆæ¡ˆï¼ˆæ¾/ç«¹/æ¢…ï¼‰ã‚’ä½œã‚‹ãŸã‚ã«ã€å¿…è¦æ¡ä»¶ã ã‘ç¢ºèªã—ã¾ã™ã€‚<br/>
       ã¾ãšã€ä»Šå›ã®<b>æ‹…å½“è€…ï¼ˆã¾ãŸã¯ãƒãƒ¼ãƒ ï¼‰</b>ã¯èª°ã§ã™ã‹ï¼Ÿ`
    );
    addChips(
      [
        {label:'Aã•ã‚“ï¼ˆæ–°äººï¼‰', value:'Aã•ã‚“ï¼ˆæ–°äººï¼‰'},
        {label:'Bã•ã‚“ï¼ˆä¸­å …ï¼‰', value:'Bã•ã‚“ï¼ˆä¸­å …ï¼‰'},
        {label:'Cã•ã‚“ï¼ˆãƒ™ãƒ†ãƒ©ãƒ³ï¼‰', value:'Cã•ã‚“ï¼ˆãƒ™ãƒ†ãƒ©ãƒ³ï¼‰'},
        {label:'2åä½“åˆ¶ï¼ˆA+Bï¼‰', value:'2åä½“åˆ¶ï¼ˆA+Bï¼‰'},
      ],
      (val)=>{ state.assignee = val; setStep(1); }
    );
  }

  function proceed(){
    if(state.step === 1){
      addMsg('bot', `å‡ºç™ºæ‹ ç‚¹ï¼ˆè»Šåº«/äº‹å‹™æ‰€ï¼‰ã¯ã©ã“ã§ã™ã‹ï¼Ÿ`);
      addChips(
        [
          {label:'æœ¬ç¤¾ï¼ˆç¥å¥ˆå·ï¼‰', value:'æœ¬ç¤¾ï¼ˆç¥å¥ˆå·ï¼‰'},
          {label:'æ”¯åº—ï¼ˆæ±äº¬ï¼‰', value:'æ”¯åº—ï¼ˆæ±äº¬ï¼‰'},
          {label:'ç¾å ´è¿‘ãã§ç›´è¡Œ', value:'ç¾å ´è¿‘ãã§ç›´è¡Œ'},
        ],
        (val)=>{ state.base = val; setStep(2); }
      );
      return;
    }

    if(state.step === 2){
      addMsg('bot', `è¨ªå•ä»¶æ•°ã¯ä½•ä»¶ãã‚‰ã„ã§ã™ã‹ï¼Ÿï¼ˆä¸Šé™ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§OKï¼‰`);
      addChips(
        [
          {label:'6ä»¶', value:'6ä»¶'},
          {label:'8ä»¶', value:'8ä»¶'},
          {label:'10ä»¶', value:'10ä»¶'},
          {label:'12ä»¶', value:'12ä»¶'},
        ],
        (val)=>{ state.visitCount = val; setStep(3); }
      );
      return;
    }

    if(state.step === 3){
      addMsg('bot', `å„ªå…ˆé †ä½ã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚`);
      addChips(
        [
          {label:'é…åˆ»ã‚¼ãƒ­ï¼ˆæ™‚é–“å³å®ˆï¼‰', value:'é…åˆ»ã‚¼ãƒ­ï¼ˆæ™‚é–“å³å®ˆï¼‰'},
          {label:'ç§»å‹•æ™‚é–“æœ€å°', value:'ç§»å‹•æ™‚é–“æœ€å°'},
          {label:'ã‚¯ãƒ¬ãƒ¼ãƒ /é›£æ¡ˆä»¶ã‚’å…ˆã«', value:'ã‚¯ãƒ¬ãƒ¼ãƒ /é›£æ¡ˆä»¶ã‚’å…ˆã«'},
          {label:'å£²ä¸Š/å˜ä¾¡å„ªå…ˆ', value:'å£²ä¸Š/å˜ä¾¡å„ªå…ˆ'},
        ],
        (val)=>{ state.priority = val; setStep(4); }
      );
      return;
    }

    if(state.step === 4){
      addMsg('bot',
        `åˆ¶ç´„ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆè¤‡æ•°OKï¼‰ã€‚é¸ã³çµ‚ãˆãŸã‚‰<b>ã€Œå‡ºåŠ›ã™ã‚‹ã€</b>ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`
      );
      const chipWrap = addChips(
        [
          {label:'Aã•ã‚“ã¯é›£æ¡ˆä»¶NG', value:'Aã•ã‚“ã¯é›£æ¡ˆä»¶NG'},
          {label:'åˆå¾Œã¯æ¸‹æ»ãŒå¢—ãˆã‚‹', value:'åˆå¾Œã¯æ¸‹æ»ãŒå¢—ãˆã‚‹'},
          {label:'åŒã‚¨ãƒªã‚¢ã¾ã¨ã‚ãŸã„', value:'åŒã‚¨ãƒªã‚¢ã¾ã¨ã‚ãŸã„'},
          {label:'åˆå›è¨ªå•ã‚’å„ªå…ˆ', value:'åˆå›è¨ªå•ã‚’å„ªå…ˆ'},
          {label:'ä½œæ¥­æ™‚é–“ãŒèª­ã‚ãªã„æ¡ˆä»¶ã‚ã‚Š', value:'ä½œæ¥­æ™‚é–“ãŒèª­ã‚ãªã„æ¡ˆä»¶ã‚ã‚Š'},
        ],
        (vals)=>{ state.constraints = vals; renderSummary(); },
        true
      );

      const btn = document.createElement('button');
      btn.className = 'primary';
      btn.textContent = 'å‡ºåŠ›ã™ã‚‹ï¼ˆæ¾/ç«¹/æ¢…ï¼‰';
      btn.style.marginTop = '10px';
      btn.addEventListener('click', ()=>{
        state.constraints = getSelectedValues(chipWrap);
        setStep(5);
        addMsg('me', 'å‡ºåŠ›ã—ã¦');
        generatePlans();
      });
      chatEl.appendChild(btn);
      chatEl.scrollTop = chatEl.scrollHeight;
      return;
    }
  }

  function handleFreeInput(){
    const text = freeInput.value.trim();
    if(!text) return;
    addMsg('me', escapeHtml(text));
    state.freeNotes.push(text);
    freeInput.value = '';
    renderSummary();

    // lightweight parser (demo-friendly)
    const t = text;
    if(!state.priority && /(é…åˆ»|æ™‚é–“|å³å®ˆ)/.test(t)) state.priority = 'é…åˆ»ã‚¼ãƒ­ï¼ˆæ™‚é–“å³å®ˆï¼‰';
    if(!state.priority && /(ç§»å‹•|æœ€å°)/.test(t)) state.priority = 'ç§»å‹•æ™‚é–“æœ€å°';
    const m = t.match(/(\d{1,2})\s*ä»¶/);
    if(!state.visitCount && m) state.visitCount = `${m[1]}ä»¶`;
    if(!state.assignee && /(A|B|C)ã•ã‚“/.test(t)){
      const mm = t.match(/(Aã•ã‚“|Bã•ã‚“|Cã•ã‚“)/);
      if(mm) state.assignee = mm[1];
    }
    renderSummary();

    addMsg('bot', 'æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚å¿…è¦æ¡ä»¶ã‚’é¸ã¶ã¨ã€ã™ãã«3æ¡ˆã‚’å‡ºã›ã¾ã™ã€‚');
  }

  function generatePlans(){
    addMsg('bot', `äº†è§£ã§ã™ã€‚æ¡ä»¶ã‚’ã‚‚ã¨ã«ã€æ¾ï¼ˆå“è³ªï¼‰/ ç«¹ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰/ æ¢…ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰ï¼‰ã®3æ¡ˆã‚’å‡ºã—ã¾ã™ã€‚`);

    const visits = makeDummyVisits(parseInt((state.visitCount||'8').replace('ä»¶',''),10) || 8);

    const plans = [
      { tier:'æ¾', badge:'b-matsu', concept:'é…åˆ»ã‚¼ãƒ­ãƒ»é›£æ¡ˆä»¶å…ˆãƒ»ä½™è£•ãƒãƒƒãƒ•ã‚¡', order: orderMatsu(visits) },
      { tier:'ç«¹', badge:'b-take', concept:'ç§»å‹•ã¨é›£æ˜“åº¦ã®ãƒãƒ©ãƒ³ã‚¹', order: orderTake(visits) },
      { tier:'æ¢…', badge:'b-ume', concept:'è¿‘ã„é †ã«å›ã—ã¦æœ€çŸ­ã§çµ‚ãˆã‚‹', order: orderUme(visits) },
    ];

    renderPlanTable(plans);
  }

  function makeDummyVisits(n){
    const areas = ['è¥¿', 'æ±', 'å—', 'åŒ—', 'ä¸­å¤®'];
    const types = ['å®šæœŸç‚¹æ¤œ', 'ç·Šæ€¥å¯¾å¿œ', 'åˆå›è¨ªå•', 'ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ', 'è¦‹ç©/ææ¡ˆ'];
    const base = state.base || 'æœ¬ç¤¾';
    const arr = [];
    for(let i=1;i<=n;i++){
      const area = areas[(i*7) % areas.length];
      const type = types[(i*5) % types.length];
      const difficulty = ['ä½','ä¸­','é«˜'][(i*3) % 3];
      const travel = 10 + ((i*13) % 45);
      const window = (i%3===0) ? 'åˆå‰' : (i%3===1 ? 'åˆå¾Œ' : 'çµ‚æ—¥');
      arr.push({
        id: `æ¡ˆä»¶${String(i).padStart(2,'0')}`,
        area,
        type,
        difficulty,
        travelMin: travel,
        window,
        note: `${base}â†’${area} / ${type}`,
      });
    }
    return arr;
  }

  function orderMatsu(visits){
    const v = [...visits];
    v.sort((a,b)=>{
      const aw = scoreDifficulty(a.difficulty) + scoreType(a.type) + scoreWindowMatsu(a.window) - a.travelMin*0.02;
      const bw = scoreDifficulty(b.difficulty) + scoreType(b.type) + scoreWindowMatsu(b.window) - b.travelMin*0.02;
      return bw - aw;
    });
    const highs = v.filter(x=>x.difficulty==='é«˜');
    const rest = v.filter(x=>x.difficulty!=='é«˜');
    const out = [];
    while(highs.length || rest.length){
      if(highs.length) out.push(highs.shift());
      if(rest.length) out.push(rest.shift());
    }
    return out;
  }

  function orderTake(visits){
    const v = [...visits];
    v.sort((a,b)=>{
      const aw = scoreType(a.type)*2 + scoreDifficulty(a.difficulty) - a.travelMin*0.03 + scoreAreaGroup(a.area);
      const bw = scoreType(b.type)*2 + scoreDifficulty(b.difficulty) - b.travelMin*0.03 + scoreAreaGroup(b.area);
      return bw - aw;
    });
    return v;
  }

  function orderUme(visits){
    const v = [...visits];
    v.sort((a,b)=>a.travelMin - b.travelMin);
    return v;
  }

  function scoreDifficulty(d){
    if(d==='é«˜') return 3;
    if(d==='ä¸­') return 2;
    return 1;
  }
  function scoreType(t){
    if(t==='ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ') return 4;
    if(t==='ç·Šæ€¥å¯¾å¿œ') return 3;
    if(t==='åˆå›è¨ªå•') return 2;
    return 1;
  }
  function scoreWindowMatsu(w){
    if(w==='åˆå‰') return 2.5;
    if(w==='åˆå¾Œ') return 1.2;
    return 1.0;
  }
  function scoreAreaGroup(a){
    if(a==='ä¸­å¤®') return 1.2;
    return 1.0;
  }

  function renderPlanTable(plans){
    outputCard.style.display = 'block';

    const note = [
      `æ‹…å½“è€…: ${state.assignee ?? 'æœªè¨­å®š'}`,
      `æ‹ ç‚¹: ${state.base ?? 'æœªè¨­å®š'}`,
      `ä»¶æ•°: ${state.visitCount ?? 'æœªè¨­å®š'}`,
      `å„ªå…ˆ: ${state.priority ?? 'æœªè¨­å®š'}`,
      `åˆ¶ç´„: ${state.constraints.length ? state.constraints.join(' / ') : 'ãªã—'}`,
      state.freeNotes.length ? `ãƒ¡ãƒ¢: ${state.freeNotes.slice(-2).join(' / ')}` : null
    ].filter(Boolean).join('  ï½œ  ');
    outputNote.textContent = note;

    const K = Math.min(8, plans[0].order.length);
    const header = `
      <thead>
        <tr>
          <th style="width:92px;">æ¡ˆ</th>
          <th>ã‚³ãƒ³ã‚»ãƒ—ãƒˆ</th>
          <th style="width:110px;">å…ˆé ­ã®è¨ªå•</th>
          <th style="width:90px;">é›£æ˜“åº¦</th>
          <th style="width:90px;">ç›®å®‰ç§»å‹•</th>
          <th>ä¸¦ã³ï¼ˆä¸Šä½${K}ä»¶ï¼‰</th>
        </tr>
      </thead>
    `;

    const rows = plans.map(p=>{
      const top = p.order[0];
      const list = p.order.slice(0,K).map(x=>`${x.id}ï¼ˆ${x.area}/${x.type}ï¼‰`).join(' â†’ ');
      const totalTravel = p.order.slice(0,K).reduce((s,x)=>s+x.travelMin,0);
      return `
        <tr>
          <td><span class="badge ${p.badge}">${p.tier}</span></td>
          <td>${escapeHtml(p.concept)}</td>
          <td>${escapeHtml(top.id)}<div class="small muted">${escapeHtml(top.window)} / ${escapeHtml(top.area)}</div></td>
          <td>${escapeHtml(top.difficulty)}</td>
          <td>${Math.round(totalTravel)}åˆ†</td>
          <td>${escapeHtml(list)}</td>
        </tr>
      `;
    }).join('');

    planTable.innerHTML = header + `<tbody>${rows}</tbody>`;
  }

  // Voice input (Web Speech API)
  function setupVoice(){
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition){
      btnVoice.addEventListener('click', ()=>{
        addMsg('bot', 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
      });
      return;
    }
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.interimResults = true;
    recognition.continuous = false;

    recognition.onstart = ()=>{
      recognizing = true;
      btnVoice.textContent = 'ğŸ¤ èã„ã¦ã„ã¾ã™...';
      btnVoice.style.opacity = '0.85';
    };
    recognition.onerror = (e)=>{
      recognizing = false;
      btnVoice.textContent = 'ğŸ¤ éŸ³å£°';
      btnVoice.style.opacity = '1';
      addMsg('bot', 'éŸ³å£°å…¥åŠ›ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å‘¨å›²ãŒé™ã‹ãªå ´æ‰€ã§ãŠè©¦ã—ãã ã•ã„ã€‚');
    };
    recognition.onend = ()=>{
      recognizing = false;
      btnVoice.textContent = 'ğŸ¤ éŸ³å£°';
      btnVoice.style.opacity = '1';
    };
    recognition.onresult = (event)=>{
      let transcript = '';
      for (let i = event.resultIndex; i < event.results.length; i++){
        transcript += event.results[i][0].transcript;
      }
      freeInput.value = transcript.trim();
      // æœ€çµ‚ç¢ºå®šã®ã¨ãã¯è‡ªå‹•é€ä¿¡
      const last = event.results[event.results.length - 1];
      if(last && last.isFinal){
        handleFreeInput();
      }
    };

    btnVoice.addEventListener('click', ()=>{
      if(recognizing){
        recognition.stop();
        return;
      }
      recognition.start();
    });
  }

  // Sample run: auto fill + auto proceed
  function runSample(){
    resetAll();
    // Simulate picks by setting state directly and pushing steps
    setTimeout(()=>{ state.assignee='Bã•ã‚“ï¼ˆä¸­å …ï¼‰'; renderSummary(); setStep(1); addMsg('me','Bã•ã‚“ï¼ˆä¸­å …ï¼‰'); proceed(); }, 350);
    setTimeout(()=>{ state.base='æœ¬ç¤¾ï¼ˆç¥å¥ˆå·ï¼‰'; renderSummary(); setStep(2); addMsg('me','æœ¬ç¤¾ï¼ˆç¥å¥ˆå·ï¼‰'); proceed(); }, 750);
    setTimeout(()=>{ state.visitCount='10ä»¶'; renderSummary(); setStep(3); addMsg('me','10ä»¶'); proceed(); }, 1150);
    setTimeout(()=>{ state.priority='ç§»å‹•æ™‚é–“æœ€å°'; renderSummary(); setStep(4); addMsg('me','ç§»å‹•æ™‚é–“æœ€å°'); proceed(); }, 1550);
    setTimeout(()=>{
      state.constraints = ['åŒã‚¨ãƒªã‚¢ã¾ã¨ã‚ãŸã„','åˆå¾Œã¯æ¸‹æ»ãŒå¢—ãˆã‚‹'];
      renderSummary();
      addMsg('me','åˆ¶ç´„ï¼šåŒã‚¨ãƒªã‚¢ã¾ã¨ã‚ãŸã„ / åˆå¾Œã¯æ¸‹æ»ãŒå¢—ãˆã‚‹');
      setStep(5);
      generatePlans();
    }, 2100);
  }

  // Events
  btnSend.addEventListener('click', handleFreeInput);
  freeInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleFreeInput(); });
  btnReset.addEventListener('click', resetAll);
  btnSample.addEventListener('click', runSample);

  // Init
  resetAll();
  setupVoice();
</script>
</body>
</html>
